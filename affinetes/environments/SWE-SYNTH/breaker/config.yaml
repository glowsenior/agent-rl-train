# Breaker Module Configuration
# Prompt templates for Bug Injector and Problem Summarizer agents

injector:
  # Bug Injector Agent - injects bugs into correct code
  system_template: |
    You are a code mutation expert creating REALISTIC bugs for software engineering benchmarks.
    Your response must contain exactly ONE bash code block with ONE command (or commands connected with && or ||).

    Include a THOUGHT section before your command where you explain your reasoning process.
    Format your response as shown in <format_example>.

    <format_example>
    THOUGHT: Your reasoning and analysis here

    ```bash
    your_command_here
    ```
    </format_example>

    Failure to follow these rules will cause your response to be rejected.

  instance_template: |
    <task>
    You are a BUG INJECTION agent creating bugs for a software engineering benchmark (like SWE-bench).
    Your goal is to introduce a REALISTIC bug that requires CODE COMPREHENSION to find and fix.

    Repository: {{repo}}
    Bug types to inject: {{bug_types_str}}
    </task>

    <bug_type_descriptions>
    {{bug_descriptions}}
    </bug_type_descriptions>

    <quality_requirements>
    ## Bug Quality Standards

    Your bug should require UNDERSTANDING THE CODE to find, not just pattern matching.

    ### ❌ BAD bugs (TOO EASY - will be rejected):
    - Simple operator flip on one line: `<` → `<=`, `!=` → `==`
    - Single condition inversion: `!flag` → `flag`, `!isPrivileged` → `isPrivileged`
    - Obvious single-token changes that any grep could find
    - Changes that only affect one line with no context needed

    ### ✅ GOOD bugs (require code comprehension):
    - Missing edge case: function works normally but fails on empty/null/boundary input
    - Wrong variable in complex expression: uses `userId` instead of `targetUserId` in nested logic
    - Incorrect state management: counter not reset, cache not invalidated, flag not cleared
    - Logic error requiring data flow analysis: wrong value propagated through multiple functions
    - Semantic error: uses createdAt instead of updatedAt, compares reference instead of value
    - Missing validation: removes a check that's only needed for specific edge cases
    - Order dependency: swaps two operations that must happen in sequence

    ### Complexity Guidelines:
    - Your bug should ideally span 2-5 lines of meaningful change
    - The fix should require understanding 30+ lines of surrounding context
    - Prefer bugs in COMPLEX functions with multiple branches, not simple getters/setters
    - The bug should be something a real developer might write when tired or unfamiliar with the code
    </quality_requirements>

    <gold_patch>
    This patch was recently applied to fix a bug. The code is now CORRECT and all tests pass.
    Your job is to re-introduce a bug (different from the original) that breaks the tests.

    Study this patch to understand the code structure, then inject a DIFFERENT bug:

    ```diff
    {{gold_patch}}
    ```
    </gold_patch>

    <target_tests>
    These tests currently PASS. Your bug should cause at least one to FAIL:
    {{target_tests_str}}
    </target_tests>

    {% if test_patch_snippet %}
    <test_code>
    Analyze these test assertions to understand what values/behaviors they expect:
    ```
    {{test_patch_snippet}}
    ```
    </test_code>
    {% endif %}

    {% if feedback %}
    <previous_attempt_feedback>
    Your previous attempt failed. Here's the feedback:
    {{feedback}}

    Please try a DIFFERENT approach this time. Consider a more complex bug type.
    </previous_attempt_feedback>
    {% endif %}

    <instructions>
    ## Your Workflow

    1. **Explore Deeply**: Read the source files to understand the FULL context, not just the changed lines
    2. **Understand Data Flow**: Trace how values are passed between functions
    3. **Find Complex Logic**: Look for functions with multiple conditions, loops, or state changes
    4. **Plan a Realistic Bug**: Think "what mistake would a developer make here?"
    5. **Inject**: Create a bug that looks like a genuine developer error
    6. **Verify**: Run tests to confirm failure, then verify it's not too obvious

    ## Bug Injection Strategy

    Think like a developer who is:
    - Tired and making a copy-paste error with similar variable names
    - Unfamiliar with edge cases and forgetting boundary checks
    - Refactoring and accidentally breaking a subtle dependency
    - Misunderstanding the order of operations in async code

    DO NOT just flip operators - that's too easy to find!

    ## Environment Setup (ALREADY DONE)

    - Working directory: /app (repository root)
    - Gold patch ALREADY APPLIED - code is correct, all tests pass
    - DO NOT apply gold_patch yourself - it's already done!

    ## Files in /workspace

    - `/workspace/gold_patch.diff` - The gold patch (already applied, for reference only)
    - `/workspace/run_tests.sh` - Run this to execute tests

    ## Commands You Should Use

    1. Read source files: `cat src/path/to/file.js` or `head -n 100 <file>`
    2. Search code: `grep -n "pattern" src/`
    3. Run tests: `bash /workspace/run_tests.sh`
    4. Edit files with sed: `sed -i 's/old/new/g' file.py`
    5. Check your changes: `git diff`

    ## Submission

    When you have successfully injected a bug that causes tests to fail:

    1. First, save your bug patch to a file (only source code changes):
    ```bash
    git diff -- '*.js' '*.ts' '*.py' '*.java' '*.go' '*.c' '*.cpp' '*.h' '*.rs' '*.rb' '*.php' > /workspace/final_bug.patch && cat /workspace/final_bug.patch
    ```

    2. Then submit with your description:
    ```bash
    echo COMPLETE_TASK_AND_SUBMIT_FINAL_OUTPUT && cat <<'RESULT'
    BUG_DESCRIPTION:
    <describe what bug you injected, why it's realistic, and why it requires understanding the code to find>
    RESULT
    ```

    IMPORTANT: The bug patch will be read from git diff. Make sure your changes are applied before submitting!
    </instructions>

  action_observation_template: |
    <returncode>{{output.returncode}}</returncode>
    {% if output.output | length < 10000 -%}
    <output>
    {{ output.output -}}
    </output>
    {%- else -%}
    <warning>
    The output of your last command was too long.
    Please try a different command that produces less output.
    </warning>
    {%- set elided_chars = output.output | length - 10000 -%}
    <output_head>
    {{ output.output[:5000] }}
    </output_head>
    <elided_chars>
    {{ elided_chars }} characters elided
    </elided_chars>
    <output_tail>
    {{ output.output[-5000:] }}
    </output_tail>
    {%- endif -%}

  format_error_template: |
    Please always provide EXACTLY ONE action in triple backticks, found {{actions|length}} actions.

    Format your response as:
    THOUGHT: Your reasoning

    ```bash
    your_command_here
    ```

  # Default limits
  step_limit: 50
  cost_limit: 10.0
  temperature: 0.7


summarizer:
  # Problem Summarizer - generates user-facing problem statement from bug
  prompt_template: |
    You are writing a bug report as a USER who encountered this issue in production.
    Write like a real user reporting a problem, NOT like a developer who has seen the code.

    ## Repository
    {{repo}}

    ## Bug Type (for your reference only - don't mention this)
    {{bug_types_str}}

    ## The Bug (Code Changes) - DO NOT REFERENCE THIS DIRECTLY
    ```diff
    {{bug_patch}}
    ```

    ## Failed Tests - use these to understand what broke
    {{failed_tests_str}}

    ## Test Error Output - use these symptoms in your report
    ```
    {{error_output}}
    ```

    {% if test_patch %}
    ## Related Test Code
    ```
    {{test_patch}}
    ```
    {% endif %}

    ## Writing Style Requirements

    Write like a FRUSTRATED USER, not a developer who knows the code:

    ### ❌ BAD (too technical - sounds like you read the code):
    "The sortOld function incorrectly inverts the comparison operands in the return statement, causing descending order instead of ascending."

    "The isPrivileged check has inverted logic in the validateTags function at the system tag validation block."

    ### ✅ GOOD (user perspective - describes experience):
    "When I sort forum topics by 'oldest first', they're showing up newest first instead. I've tried refreshing the page and clearing my browser cache but it's still backwards. This started happening recently."

    "Admin users are getting 'You cannot use this tag' errors when trying to add system tags to topics, but regular users can add them just fine. The permissions seem to be reversed."

    ## Report Format

    Write a bug report with this structure:

    **Title-style summary** (one line describing the problem)

    **What I was trying to do:** (1-2 sentences)

    **What happened instead:** (1-2 sentences with specific symptoms)

    **Additional details:** (optional - browser, "this used to work", frequency, etc.)

    ## Critical Rules

    1. NEVER mention: line numbers, function names, variable names, diffs, patches
    2. NEVER say: "the code does X" or "the function returns Y"
    3. ALWAYS describe: what you tried to do, what you expected, what actually happened
    4. USE specific values from error output when describing symptoms
    5. SOUND like a user who is confused/frustrated, not a developer debugging
    6. Include realistic details: browser, "I tried X but it didn't help", "my colleague has the same issue"

    ## Examples

    Example 1 (permission bug):
    "Admin users blocked from using system tags

    I'm a forum admin trying to add the 'announcement' system tag to an important topic. When I save, I get an error saying I can't use system tags. Strangely, when I asked a regular user to try, they were able to add it without any issues.

    I've tried logging out and back in, and even created a new admin account - same problem. Other admins on our team are seeing this too. Is there something wrong with the permission system?"

    Example 2 (sorting bug):
    "Topics sorted wrong when using 'oldest first'

    On the category page, when I click to sort by oldest topics first, the list shows the newest topics at the top instead. It's basically doing the opposite of what I selected.

    Browser: Chrome 120 on Windows. I cleared cache and tried Firefox too - same issue. The 'newest first' sort works correctly though."

    Example 3 (data display bug):
    "User profiles showing wrong information in header

    When I visit my profile page, the header section shows my email address where my username should be. My actual username appears fine in other places like comments, but the profile header is wrong.

    This is happening for all users on our forum, not just me. Pretty embarrassing since email addresses are now visible to everyone who visits a profile!"

    Output ONLY the bug report in the format above, no other text:
